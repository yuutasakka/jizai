# 要件定義書（JIZAI 遺影編集）v1.3

作成日: 2025-08-29
対象: **遺影写真の編集・仕上げ**に特化した単機能アプリ（Web/ iOS）。汎用編集/家族共有/サブスク保管は将来機能としてスコープ外に退避。

---

## 0. 本ドキュメントの位置づけ / 変更履歴

* 目的: 機能を葬儀用途に絞り、**初見でも迷わない体験**と**式典プリント要件への完全準拠**を実現する。
* 適用範囲: フロント（LP/アプリUI）、バックエンド（編集/書き出しAPI）、印刷書き出し仕様、運用/法務。
* 変更履歴:

  * v1.3（2025-08-29）: **料金プランをクレジット（枚）制に刷新**（2/10/20/50/100枚・スタッフにおまかせ）。UIの1件価格カードを非表示化。JSON-LD `offers.lowPrice` を **160 JPY** に更新。`/public/og.png` のデフォルトOG/Twitter画像を明示。
  * v1.2（2025-08-29）: セキュリティ/運用指針を追加（環境変数管理・CORS/HSTS/CSP・RLS・ログ最小化・監視/診断・SAST/DAST・運用チェックリスト）。
  * v1.1（2025-08-29）: 用途別LP（遺影/ペット遺影/生前撮影/メモリアルフォト）とSEO（title/desc/JSON-LD/サイトマップ/robots/パンくず）を要件化。内部リンク/ナビを追加。
  * v1.0（2025-08-29）: 葬儀特化へ全面刷新。家族共有/Vault/英訳UIを非表示化。プリント対応を正式要件化。

---

## 1. 目的 / 背景

* ユーザー課題: 急ぎで**自然な遺影**を用意したいが、どの設定/サイズを選ぶか分かりにくい。費用/納期の不安。
* 提供価値: **プリセット選択→確認→サイズ書き出し**の最短導線と、**四つ切・A4・L判**など式典サイズへの自動最適化。
* 成功指標（KPI）: 初回体験完了率 ≥ 70% / 当日完了率 ≥ 60% / 再編集率 ≤ 20% / CS満足度 ≥ 4.5/5。

---

## 2. ペルソナ / ユースケース

* ペルソナ: 喪主/親族（非デザイナー）。**当日〜翌日**に間に合わせたい、自然さ優先、ミスを避けたい。
* 主な利用シーン: 服装の整え（喪服/ネクタイ）、背景の無地化、髪の乱れ/肌、メガネ反射軽減、サイズ書き出し、簡易色補正。

---

## 3. スコープ（In / Out）

**In（MVP）**

* 遺影プリセット（選択式）: 服装（喪服/白シャツ+黒ネクタイ）、背景（白/薄グレー/やわらかグラデ）、整え（髪/肌/反射）。
* 自由入力は折りたたみ（上級者向け）。
* 印刷書き出し: 四つ切/ A4/ L判/ 小キャビネ/ 2L、**300/350dpi**、**塗り足し3mm**、sRGB、DPIメタ埋め込み。
* ワークフロー: アップロード → プリセット → プレビュー → 承認 → サイズ/書き出し。
* 料金UI: **1件価格**で提示（セルフ/おまかせ/高度修復）。
* お急ぎ: 当日（目安2h〜）の優先処理オプション。

**Out（将来）**

* 家族共有・期間付き権限、Vault（月額SaaS）、B2B一括管理、英訳UI露出（裏側の翻訳最適化は可）国際化対応ライブラリを使用。

---

## 4. 料金/商品構成（UIに表示）

**クレジット（枚＝回数の目安）**

* **2枚**：**¥160**（**通常¥200**／**1枚=¥80（通常¥100）**）
* **10枚**：**¥700**（**1枚=¥70**）
* **20枚**：**¥1,400**（**1枚=¥70**）
* **50枚**：**¥3,250**（**1枚=¥65**）
* **100枚**：**¥6,000**（**1枚=¥60**）

**有人仕上げ（スタッフにおまかせ）**

* **¥4,980/件**（人手チェック・色/髪/肌の最終調整・優先対応）

**UIルール**

* 価格表示は**クレジット（枚）カード**＋**1枚あたり**の単価（サブ文）。
* **2枚**のみ「今だけ」ピル＋通常価格（¥200）取り消し線を併記。
* 旧「1件価格」カード（セルフ/おまかせ/高度修復）は**非表示**。必要な文脈は「スタッフにおまかせ（¥5,980）」に集約。
* IAPは `2/10/20/50/100枚` と `スタッフにおまかせ(1件)` の6 SKU。

---

## 5. 機能要件（FR）

### 5.1 プリセット編集

* 服装: 喪服/白シャツ+黒ネクタイ（性別選択あり）
* 背景: 無地白/薄グレー/やわらかグラデ（段階3種）
* 整え: 髪の乱れ、肌（自然な範囲）、メガネ反射軽減、色味補正（軽度）
* 自由入力: 折りたたみ。中立文言（「送信内容プレビュー」）のみ表示。**AI/英訳の語はUIに出さない。**

### 5.2 プレビュー/承認

* Before/Afterスライダー、ズーム。差し戻し2回まで無料（同一ジョブ内/24h）。
* 品質ガード: セーフマージン**5mm**表示、顔や文字が断裁域へ出た場合の警告。

### 5.3 印刷書き出し

* サイズ: 四つ切(254×305mm) / A4(210×297mm) / L判(89×127mm) / 小キャビネ(120×165mm) / 2L(127×178mm)
* 解像度: **300/350dpi**、色空間: **sRGB**、形式: **JPEG(95, 4:4:4)** / オプション **TIFF(8bit sRGB)**
* オプション: リサイズモード（**フィット**余白/ **フィル**断裁）、塗り足し**3mm**（既定ON）、額縁mm・色。
* メタ: DPI/ICC埋め込み、ファイル名例 `Yotsugiri_350dpi_bleed3mm.jpg`。

### 5.4 サポート/お急ぎ

* 右上: 「**お急ぎの方（今すぐ相談）**」電話/チャット導線。目安納期表示（最短2h）。

---

## 6. 印刷仕様（参照表）

| サイズ   | 仕上がり(mm) | 300dpi(px) | 350dpi(px) | 塗り足し3mm込み 300dpi(px) | 350dpi(px) |
| ----- | -------- | ---------- | ---------- | -------------------- | ---------- |
| 四つ切   | 254×305  | 3000×3602  | 3500×4203  | 3071×3673            | 3583×4285  |
| A4    | 210×297  | 2480×3508  | 2894×4093  | 2551×3579            | 2976×4175  |
| L判    | 89×127   | 1051×1500  | 1226×1750  | 1122×1571            | 1301×1821  |
| 小キャビネ | 120×165  | 1417×1949  | 1654×2271  | 1488×2019            | 1732×2342  |
| 2L判   | 127×178  | 1500×2102  | 1750×2453  | 1571×2172            | 1821×2523  |

> 数値は仕様上の目安。書き出し前に自動検証し、不一致時は警告。

---

## 7. 非機能要件（NFR）

* 性能: p90 生成 ≤ 10s / p90 書き出し ≤ 5s（Wi‑Fi）
* 可用性: 99.9%/月（編集/書き出しAPI）
* 品質: sRGB/ICC埋込、DPIメタ埋込、塗り足し/セーフマージンガイド
* セキュリティ/プライバシー: TLS1.2+、最小権限、30日自動削除、国外移転の同意、ログ最小化
* アクセシビリティ: 44ptタップ、AAコントラスト、数値強調

---

## 8. 画面 & フロー（MVP）

* **Home**: ヒーロー（遺影特化文言）→ 使い方3ステップ → 料金 → 実例 → FAQ → 法務リンク
* **用途別LP（4ページ）**:

  * `/memorial/human`（遺影・人）/ `/memorial/pet`（ペット遺影）/ `/memorial/seizen`（生前撮影）/ `/memorial/photo`（メモリアルフォト）
  * 各ページに Hero / 使い方 / 用途別プリセット推奨 / サイズ・印刷 / 実例 / 料金 / FAQ / 法務
* **ナビゲーション**: ヘッダに「用途別」ドロップダウン、フッターにも用途別リンク群
* **パンくず**: Home > 用途別 > ページ名（JSON-LD出力）
* **編集**: アップロード → プリセット（既定）→ プレビュー → 承認
* **出力**: サイズ/DPI/塗り足し/リサイズ/額縁 → 断裁ガイド → 書き出し
* **サポート**: お急ぎ/問い合わせ

---

## 9. API（要点）

* `POST /v1/edit` … 編集実行（差し戻し2回まで同一ジョブ無料）
* `POST /v1/print/export` … サイズ/DPI/塗り足し/額縁でJPEG/TIFF書き出し（sRGB/ICC/metadata.density）
* `GET /v1/jobs/:id` … 出力URL/ログ（最終送信内容のテキストは返すがUIは中立表記）

---

## 10. データ設計（最小）

* `EditJob` { id, preset, note, status, retries\_left(=2), createdAt, finishedAt }
* `Asset` { id, jobId, role(input|output), url, mime, bytes, w, h }
* `PrintRequest` { id, jobId, size\_key, dpi, bleed\_mm, mode, frame\_mm, filename }
* `Order` { id, plan(self|pro|repair), rush(boolean), price, status }

---

## 11. 運用 / SLA

* 標準納期: 当日〜翌日、**お急ぎ**: 最短2h（枠による）
* データ保管: 30日自動削除
* 障害対応: 監視/通知、ステータスページ

---

## 12. 法務 / 表示

* プライバシー/利用規約/特商法をフッター常設。国外処理・第三者提供・同意/撤回の明記。
* 禁止事項: 権利侵害、なりすまし、わいせつ等（規約準拠）。

---

## 13. 計測 / KPI

* **ファネル**: LP→写真アップ→プリセット完了→承認→書き出し
* **検索流入**: 用途別キーワード（遺影/ペット遺影/生前撮影/メモリアルフォト）

  * 指標: **表示回数 / CTR / 平均掲載順位 / クリック**（GSC）
* **運用指標**: 当日完了率、差し戻し率、サイズ別比率、問い合わせ率
* **A/B**: ヒーロー文言（当日仕上げ vs 差し戻し2回無料）、用途別1枚目の実例

---

## 14. テスト計画（抜粋）

* 受入: プリセット→承認→四つ切/350dpi/塗り足し3mmの書き出しが表と一致
* 回帰: 断裁ガイド表示、セーフマージン警告、TIFF書き出し
* 端末: iPhone 11/12/13/14/15（iOS16+）

---

## 15. ロードマップ（将来）

* P2: **プリント/額装注文**（外部ラボ）
* P3: **B2B葬儀社ポータル**（一括アップ/進捗）
* P4: **Memorial Vault（月額SaaS）**（別プロダクトとして）

---

## 16. SEO / 情報設計（用途別LP）

* **メタ**: `<title>`/`<meta name="description">` を用途別に最適化（例: 遺影=四つ切/A4/L判対応、当日仕上げ）。
* **カノニカル**: 各用途ページに `<link rel="canonical">`。
* **構造化データ**: JSON-LD `Service` + `FAQPage` + `HowTo` + `BreadcrumbList` を挿入。

  * `Service.offers.lowPrice` は **160 JPY** に統一。
* **サイトマップ/robots**: `/sitemap.xml` に4ページを列挙、`robots.txt` に Sitemap を明記。
* **OG/Twitter**: 既定のOG画像は **`/public/og.png`** （1200×630 / <300KB）を使用。`layout.tsx` と `generateMetadata` で参照。
* **内部リンク**: ヘッダ「用途別」/ フッターリンク / 本文内の関連リンク（遺影↔生前撮影 など）。
* **画像最適化**: LCP画像を優先読み込み、主要画像に用途名の `alt` を付与。
* **見出し**: H1=用途名、H2=使い方/実例/サイズ・印刷/料金/FAQ、Hタグ階層を遵守。

### 付録 B: 用途別ページの見出し・ディスクリプション（たたき）

* **/memorial/human**

  * H1: 遺影写真の編集と仕上げ
  * desc: 四つ切・A4・L判対応。服装・背景・肌/髪の整え。当日仕上げ可。
* **/memorial/pet**

  * H1: ペット遺影の編集と仕上げ
  * desc: 毛並みの整え・背景無地化・色味補正。四つ切/A4/L判、当日対応。
* **/memorial/seizen**

  * H1: 生前撮影のレタッチと最適仕上げ
  * desc: 終活ポートレートの整えとサイズ書き出し。自然な仕上がりで。
* **/memorial/photo**

  * H1: メモリアルフォトの編集
  * desc: 法要・命日の写真整えと印刷最適化。四つ切/A4/L判。

---

## 付録 A: 文言（LP/アプリ）

* H1: **遺影写真の編集と仕上げ、すぐに。**
* サブ: **四つ切・A4・L判対応／1件〜当日仕上げ**
* 注意: **※プレビューは英語表記です。画像に日本語の文字を入れる場合は、その部分を日本語に置き換えてから生成してください。**
* 料金カード: **セルフ ¥1,480 / おまかせ ¥3,980 / 高度修復 ¥6,980〜**

---

## 17. セキュリティ / 運用指針（最終仕上げ）

**1) 取得情報（キー/秘密）**

* 環境変数は `.env*` / Vercel Env 経由（フロント直埋め込み禁止）を厳守。
* ハードコード監査：リポジトリ全体（履歴含む）を秘密検知（例: `gitleaks` / ripgrep で `"(sk-|AKIA|AIza|-----BEGIN|secret|api[_-]?key)"`）。
* 管理画面（GitHub/Vercel/Supabase）は **MFA必須**。

**2) データ保存（at-rest）**

* DB/ストレージはプラットフォーム標準の暗号化。Supabase バケットは **private** を基本。
* クライアント保存は機微を避け、必要最小（現状 deviceId のみ）。
* バックアップは暗号化・権限最小で保管、定期点検。

**3) ネットワーク（in-transit）**

* HTTPS/TLS（Vercel標準）。**HSTS**を本番で段階導入（`Strict-Transport-Security: max-age=31536000; includeSubDomains; preload`）。
* **CORS** は本番で `NEXT_PUBLIC_SITE_URL` のみに絞る（開発時は `.env` 切替）。
* レート制限は閾値と監視を運用へ。
* セキュリティヘッダ：`X-Frame-Options=SAMEORIGIN` / `X-Content-Type-Options=nosniff` / `Referrer-Policy=strict-origin-when-cross-origin`（導入済）。
* **CSP** は Report-Only → 本適用へ段階導入（script/img/connect/style の許可先を最小化）。

**4) プライバシー**

* 収集は最小・目的明示（プライポリ/ヘルプ）。
* **ログ健全化**：サーバの生成リクエストから **prompt 等の機微**は出力しない（jobId/サイズ等に置換）。
* 第三者SDK（GA4）は匿名IP設定、共有範囲をドキュメント化。

**5) 権限/アクセス制御**

* サーバ側で必ず認可検証（クライアント依存NG）。
* Supabase は **RLS 有効**・`anon` の不要権限剥奪・テーブル毎の最小権限徹底。
* ストレージ直リンクが未認証で閲覧できないことをシークレットウィンドウで確認。

**6) コードセキュリティ**

* XSS/インジェクション対策（エスケープ・パラメータ化・入力検証）。
* WebView/外部読み込みは信頼ドメインに限定。iOS は ATS 有効を推奨。
* 本番で冗長ログ/スタックを出さない。

**7) ライブラリ管理**

* 依存の脆弱性監視：`npm audit` / Dependabot / SCA。未使用依存は削除、minor/patch を定期反映。

**8) 配信/保護（モバイル）**

* iOS: ATS 必須、必要に応じて証明書ピンニング、改ざん検知の検討。
* ストア要件（Target API 等）順守（Android対象時）。

**9) セキュリティテスト/監査**

* **SAST/DAST**：ZAP/Burp 等で簡易診断。重要機能は侵入テスト（第三者）も検討。
* 回帰防止：CI で **LHCI（導入済）**＋E2E/ユニット。

**10) ログ/監視**

* **Uptime**：`/memorial/human` を200監視。
* エラー検知：Vercel/Sentry等で通知。
* ログ保全：アクセス制御/保持期間を定義。機微値は保存しない。

### 短期推奨アクション（このリポジトリ特有）

* **ログ健全化**：生成リクエストログから `prompt` を除去/マスク。
* **CORS締め**：allowedOrigins を `NEXT_PUBLIC_SITE_URL` のみに（開発時は `.env` 切替）。
* **HSTS導入**：本番のみ `Strict-Transport-Security` を付与。
* **CSP試験**：`Content-Security-Policy-Report-Only` を導入し違反収集→本適用。
* **RLS点検**：Supabase の RLS/権限SQLを定期実行（セキュリティアドバイザーでも確認）。

### 付録 C: 確認コマンド例

* 秘密検査：`rg -n "(sk-|AKIA|AIza|-----BEGIN|secret|api[_-]?key)" -S`
* 依存脆弱性：`npm audit --production`
* SSG/メタ：`npm run next:build && npm run next:start` → `curl -I http://localhost:3000/memorial/human`
* ヘッダ：`curl -I http://localhost:3000/memorial/human | sed -n '1,20p'`（XFO/CTO/Referrer-Policy/HSTS 確認）
* LHCI：PRで自動実行（assert 失敗時はコンソールを確認）

---

---

## 付録 D: IAP SKU（App Store Connect / CSV たたき）

```
product_id,type,display_name,price_jpy,credits,description
com.jizai.coins2,consumable,2枚,160,2,1枚=¥80（通常¥100）/ 通常価格 ¥200
com.jizai.coins10,consumable,10枚,700,10,1枚=¥70
com.jizai.coins20,consumable,20枚,1400,20,1枚=¥70
com.jizai.coins50,consumable,50枚,3250,50,1枚=¥65
com.jizai.coins100,consumable,100枚,6000,100,1枚=¥60
com.jizai.staff.service,consumable,スタッフにおまかせ（1件）,5980,0,有人仕上げ/1件
```

## 付録 E: DevOps補遺（Git基準ブランチの安定解決）

* `origin/HEAD` 依存を撤廃し、`git remote show origin` で既定ブランチ（main/master）を解決してから `merge-base` を取得。
* 参考スクリプト: `scripts/git-default-branch.sh` / `scripts/git-merge-base.sh` / `scripts/changed-files.sh`。
