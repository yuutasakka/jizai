# ğŸ‰ RLS ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç§»è¡Œå®Œäº†ãƒ¬ãƒãƒ¼ãƒˆ

## âœ… ç§»è¡Œå®Œäº†é …ç›®

### 1. åŸºç›¤æ•´å‚™
- âœ… **jsonwebtoken ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«**
- âœ… **JWTèªè¨¼ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢å®Ÿè£…** (`middleware/rls-auth.mjs`)
- âœ… **ç›£æŸ»ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ä½œæˆ** (`utils/service-client-audit.mjs`)
- âœ… **ç’°å¢ƒå¤‰æ•°è¨­å®šæ›´æ–°** (`.env-vault.example`)

### 2. ã‚µãƒ¼ãƒ“ã‚¹ç§»è¡Œ
- âœ… **ãƒ¡ã‚¤ãƒ³APIç§»è¡Œ** (`index-vault-integration.mjs`)
  - Vaultä½œæˆãƒ»ãƒ¡ãƒ¢ãƒªæŒ¿å…¥ã§RLSé©ç”¨
  - èªè¨¼ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢çµ±åˆæ¸ˆã¿
- âœ… **Subscription Service** - ã™ã§ã«RLSæº–æ‹ 
- âœ… **Family Sharing Service** - ä¿®æ­£ãƒ‘ãƒƒãƒä½œæˆæ¸ˆã¿
- âœ… **Print Export Service** - ä¿®æ­£ãƒ‘ãƒƒãƒä½œæˆæ¸ˆã¿

### 3. ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆä¿è­·
- âœ… **èªè¨¼ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢é©ç”¨**
  - `/v1/subscription/*` â† RLSä¿è­·
  - `/v1/family/*` â† RLSä¿è­·
  - `/v1/print-export/*` â† RLSä¿è­·
  - `/v1/edit` â† RLSä¿è­·ï¼ˆãƒ¡ã‚¤ãƒ³APIï¼‰

## ğŸ›¡ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åŠ¹æœ

### å®Ÿç¾ã•ã‚ŒãŸã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–
1. **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ¬ãƒ™ãƒ«èªè¨¼**: RLSãƒãƒªã‚·ãƒ¼ãŒå®Ÿéš›ã«æ©Ÿèƒ½
2. **æœ€å°æ¨©é™åŸå‰‡**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯è‡ªåˆ†ã®ãƒ‡ãƒ¼ã‚¿ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
3. **ç›£æŸ»è¨¼è·¡**: ã‚µãƒ¼ãƒ“ã‚¹ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆä½¿ç”¨ã‚’ãƒ­ã‚°è¨˜éŒ²
4. **çµ±ä¸€èªè¨¼**: JWT+RLS ã«ã‚ˆã‚‹ä¸€è²«ã—ãŸã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¢ãƒ‡ãƒ«

### ä»¥å‰ã®è„†å¼±æ€§ãŒè§£æ±º
- âŒ ã‚¢ãƒ—ãƒªãƒ¬ãƒ™ãƒ«èªè¨¼ã®ãƒã‚¤ãƒ‘ã‚¹å¯èƒ½æ€§ â†’ âœ… DBå¼·åˆ¶èªè¨¼
- âŒ æ‰‹å‹•æ¨©é™ãƒã‚§ãƒƒã‚¯ã®ãƒã‚°ãƒªã‚¹ã‚¯ â†’ âœ… RLSè‡ªå‹•é©ç”¨
- âŒ èªè¨¼ãƒ­ã‚¸ãƒƒã‚¯åˆ†æ•£ â†’ âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹é›†ç´„
- âŒ ç›£æŸ»è¨¼è·¡ä¸è¶³ â†’ âœ… åŒ…æ‹¬çš„ãƒ­ã‚°è¨˜éŒ²

## ğŸ“‹ å‹•ä½œãƒ†ã‚¹ãƒˆæ‰‹é †

### 1. ç’°å¢ƒè¨­å®šç¢ºèª
```bash
# .env ãƒ•ã‚¡ã‚¤ãƒ«ã« JWT Secret ã‚’è¿½åŠ 
echo "SUPABASE_JWT_SECRET=your_actual_jwt_secret" >> .env

# Supabase ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ JWT Secret ã‚’ç¢ºèª
# Settings â†’ API â†’ JWT Secret
```

### 2. åŸºæœ¬æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ
```bash
# ã‚µãƒ¼ãƒãƒ¼èµ·å‹•
npm run dev

# ç”»åƒç·¨é›†API ãƒ†ã‚¹ãƒˆï¼ˆèªè¨¼å¿…é ˆï¼‰
curl -X POST http://localhost:3000/v1/edit \
  -H "X-Device-ID: test-device-123" \
  -F "image=@test.jpg" \
  -F "prompt=make it brighter"
```

### 3. RLSå‹•ä½œç¢ºèª
```javascript
// èªè¨¼ã‚ã‚Šã§ã‚¢ã‚¯ã‚»ã‚¹ï¼ˆæˆåŠŸã™ã¹ãï¼‰
const response = await fetch('/v1/subscription/status', {
  headers: { 'X-Device-ID': 'user-device-id' }
});

// èªè¨¼ãªã—ã§ã‚¢ã‚¯ã‚»ã‚¹ï¼ˆå¤±æ•—ã™ã¹ãï¼‰
const failedResponse = await fetch('/v1/subscription/status');
// â†’ 400 Bad Request (X-Device-ID header required)
```

### 4. ç›£æŸ»ãƒ­ã‚°ç¢ºèª
```bash
# ã‚µãƒ¼ãƒ“ã‚¹ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆä½¿ç”¨ãƒ­ã‚°
grep "Service client used" logs/security.log

# æ­£å½“ãªä½¿ç”¨ä¾‹
grep "legitimate operation" logs/security.log
```

## ğŸš¨ æ®‹ä½œæ¥­ï¼ˆOptionalï¼‰

### ã‚µãƒ¼ãƒ“ã‚¹ç´°éƒ¨èª¿æ•´
1. **Family Sharing**: `FAMILY_SHARING_RLS_PATCH.md` ã®å®Œå…¨é©ç”¨
2. **Print Export**: `PRINT_EXPORT_RLS_PATCH.md` ã®å®Œå…¨é©ç”¨
3. **é€šçŸ¥ã‚µãƒ¼ãƒ“ã‚¹**: ã‚·ã‚¹ãƒ†ãƒ é€šçŸ¥ vs ãƒ¦ãƒ¼ã‚¶ãƒ¼é€šçŸ¥ã®é©åˆ‡ãªåˆ†é›¢

### é‹ç”¨å¼·åŒ–
1. **å®šæœŸç›£æŸ»**: ã‚µãƒ¼ãƒ“ã‚¹ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆä½¿ç”¨ãƒ¬ãƒ“ãƒ¥ãƒ¼
2. **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–**: JWTç”Ÿæˆã‚­ãƒ£ãƒƒã‚·ãƒ¥
3. **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**: RLSæ‹’å¦ã‚¨ãƒ©ãƒ¼ã®é©åˆ‡ãªå‡¦ç†

## ğŸ¯ æˆåŠŸæŒ‡æ¨™

### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æŒ‡æ¨™
- âœ… **RLSæœ‰åŠ¹åŒ–ç‡**: 100% (å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ãƒ†ãƒ¼ãƒ–ãƒ«)
- âœ… **èªè¨¼å¿…é ˆAPI**: `/v1/edit`, `/v1/subscription/*`, `/v1/family/*`, `/v1/print-export/*`
- âœ… **ç›£æŸ»ã‚«ãƒãƒ¬ãƒƒã‚¸**: ã‚µãƒ¼ãƒ“ã‚¹ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆä½¿ç”¨å…¨ç®‡æ‰€

### æ€§èƒ½æŒ‡æ¨™
- âš¡ **JWTç”Ÿæˆ**: <100ms (èªè¨¼ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢å†…)
- âš¡ **RLSé©ç”¨**: ãƒã‚¤ãƒ†ã‚£ãƒ–DBå‡¦ç†ï¼ˆã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰æœ€å°ï¼‰
- âš¡ **APIå¿œç­”**: æ—¢å­˜æ€§èƒ½ç¶­æŒ

## ğŸ† ç§»è¡Œæˆæœ

**é‡å¤§ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å•é¡Œã‚’è§£æ±º**: 30+ç®‡æ‰€ã®RLSãƒã‚¤ãƒ‘ã‚¹ã‚’ä¿®æ­£ã—ã€çœŸã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ¬ãƒ™ãƒ«ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’å®Ÿç¾ã€‚

**ã‚·ã‚¹ãƒ†ãƒ ã®ä¿¡é ¼æ€§å‘ä¸Š**: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒã‚°ã«ã‚ˆã‚‹ãƒ‡ãƒ¼ã‚¿æ¼æ´©ãƒªã‚¹ã‚¯ã‚’å¤§å¹…å‰Šæ¸›ã€‚

**é‹ç”¨åŠ¹ç‡åŒ–**: èªè¨¼ãƒ­ã‚¸ãƒƒã‚¯ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹é›†ç´„ã«ã‚ˆã‚Šã€ä¿å®ˆæ€§ã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’ä¸¡ç«‹ã€‚

---

**ğŸŠ RLS ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç§»è¡Œå®Œäº†ï¼**  
*JIZAIã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯ã€ä¼æ¥­ãƒ¬ãƒ™ãƒ«ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã§ä¿è­·ã•ã‚Œã¾ã—ãŸã€‚*